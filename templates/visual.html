<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application window streaming</title>
    <link href="/assets/css/css_fonts.css" rel="stylesheet">
    <link href="/assets/css/main.css" rel="stylesheet">
</head>

<body class="body-stream">
    <div class="container-stream">
        <!-- Header -->
        <div class="header-stream">
            <h1>üé• Application window streaming</h1>
            <div class="client-info">
                <div class="status-item-stream">
                    <span class="status-label-stream">User ID</span>
                    <strong>{{ client_id }}</strong>
                </div>
                <div class="status-indicator connected"></div>
                <div class="status-item-stream">
                    <span class="status-label-stream">Active users</span>
                    <span class="status-value-stream" id="clientCount">0</span>
                </div>
            </div>
        </div>

        <!-- Stats Display -->
        <div class="stats-display">
            <div class="stat-card">
                <div class="stat-value-stream" id="activeWindows">0</div>
                <div class="stat-label-stream">Active windows</div>
            </div>
            <div class="stat-card">
                <div class="stat-value-stream" id="totalFrames">0</div>
                <div class="stat-label-stream">Total frames</div>
            </div>
            <div class="stat-card">
                <div class="stat-value-stream" id="updateRate">0 FPS</div>
                <div class="stat-label-stream">Refresh rate</div>
            </div>
        </div>

        <!-- Main Video Container -->
        <div class="video-box tiled">
            <div class="video-title">
                <span>üì∫ Tiled view (all windows)</span>
                <button class="control-btn-stream screenshot" onclick="captureScreenshot('tiled')">
                    üì∏ Screenshot
                </button>
            </div>
            <div class="status-box connected" id="statusTiled">
                <div class="status-indicator connected"></div>
                <span>Connection established</span>
            </div>
            <div class="video-container">
                <img src="/visual/video_feed_tiled" id="videoTiled" alt="Tiled view" />
            </div>
        </div>

        <!-- Individual Windows Container -->
        <div id="windowsContainer" class="video-grid"></div>

        <!-- Controls Panel -->
        <div class="controls-panel-stream">
            <h2>üéÆ Broadcast management</h2>
            <div class="controls-grid">
                <button class="control-btn-stream" onclick="location.reload()">
                    üîÑ Refresh page
                </button>
                <button class="control-btn-stream" onclick="updateStats()">
                    üìä Update statistics
                </button>
                <button class="control-btn-stream screenshot" onclick="captureAllScreenshots()">
                    üì∏ Screenshots of all windows
                </button>
                <button class="control-btn-stream" onclick="forceRedraw()">
                    üé® Forced redrawing
                </button>
                <button class="control-btn-stream" onclick="placeWindows()">
                    ü™ü Arrange windows in halves
                </button>
                <button class="control-btn-stream" onclick="placeWindowLeft()">
                    ‚¨ÖÔ∏è Window on the left
                </button>
                <button class="control-btn-stream" onclick="placeWindowRight()">
                    ‚û°Ô∏è Window on the right
                </button>
            </div>
        </div>
    </div>


    <div id="fullscreenModal" class="modal">
        <span class="close-modal">&times;</span>
        <div id="modalContentContainer">
            <img id="fullscreenImage" class="modal-content" src="" alt="Full-screen image" />
            <div class="modal-info">Click on the image or press the ESC key to exit</div>
        </div>
    </div>

    <script>
        let windowsCount = 0;
        let frameCount = 0;
        let lastUpdate = Date.now();
        
        function updateStats() {
            fetch('/visual/client_stats')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('clientCount').textContent = data.active_clients;
                    // Update FPS calculation
                    const now = Date.now();
                    const elapsed = (now - lastUpdate) / 1000;
                    if (elapsed > 0) {
                        const fps = Math.round(frameCount / elapsed);
                        document.getElementById('updateRate').textContent = `${fps} FPS`;
                    }
                    lastUpdate = now;
                    frameCount = 0;
                });
        }
        
        function setupVideo(imgId, statusId, url, isTiled = false) {
            const img = document.getElementById(imgId);
            const status = document.getElementById(statusId);
            
            img.onload = function() {
                status.innerHTML = '<div class="status-indicator connected"></div><span>‚úÖ Connected</span>';
                status.classList.add('connected');
                frameCount++;
                
                if (modal.style.display === 'flex' && fullscreenImage.src === url) {
                    fullscreenImage.src = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
                }
                
                if (isTiled) {
                    updateWindowCount();
                }
            };
            
            img.onerror = function() {
                status.innerHTML = '<div class="status-indicator" style="background: #ef4444;"></div><span>üîÑ Reconnecting...</span>';
                status.classList.remove('connected');
                setTimeout(() => { 
                    img.src = url + '?t=' + Date.now(); 
                }, 1000);
            };
        }
        
        function updateWindowCount() {
            fetch('/visual/windows_count')
                .then(r => r.json())
                .then(data => {
                    if (data.count !== windowsCount) {
                        windowsCount = data.count;
                        document.getElementById('activeWindows').textContent = windowsCount;
                        createWindowElements();
                    }
                });
        }
        
        function createWindowElements() {
            const container = document.getElementById('windowsContainer');
            container.innerHTML = '';
            
            for (let i = 0; i < windowsCount; i++) {
                const windowBox = document.createElement('div');
                windowBox.className = 'video-box';
                windowBox.innerHTML = `
                    <div class="video-title">
                        <span>üñºÔ∏è Window ${i+1}</span>
                        <button class="control-btn-stream screenshot" onclick="captureScreenshot('window', ${i})">
                            üì∏ Screenshot
                        </button>
                    </div>
                    <div class="status-box" id="statusWindow${i}">
                        <div class="status-indicator connected"></div>
                        <span>Connecting...</span>
                    </div>
                    <div class="video-container">
                        <img src="/visual/video_feed_window/${i}" id="videoWindow${i}" alt="Window ${i+1}" />
                    </div>
                `;
                container.appendChild(windowBox);
                
                setTimeout(() => {
                    setupVideo(`videoWindow${i}`, `statusWindow${i}`, `/visual/video_feed_window/${i}`);
                }, 100);
            }
        }
        
        function captureScreenshot(type, index = null) {
            let url = '';
            let filename = '';
            
            if (type === 'tiled') {
                url = '/visual/screenshot_tiled';
                filename = 'screenshot_tiled.jpg';
            } else if (type === 'window' && index !== null) {
                url = `/visual/screenshot_window/${index}`;
                filename = `screenshot_window_${index+1}.jpg`;
            }
            
            if (url) {
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        function captureAllScreenshots() {
            captureScreenshot('tiled');
            for (let i = 0; i < windowsCount; i++) {
                setTimeout(() => { captureScreenshot('window', i); }, i * 500);
            }
        }
        
        function forceRedraw() {
            fetch('/visual/force_redraw_all')
                .then(r => r.text())
                .then(data => {
                    alert('The redrawing was done successfully!');
                    location.reload();
                })
                .catch(() => {
                    alert('Error during redrawing');
                });
        }
        
        function placeWindows() {
            fetch('/visual/place_windows')
                .then(r => r.text())
                .then(data => {
                    alert('Windows successfully placed!');
                    location.reload();
                })
                .catch(() => {
                    alert('Error placing windows');
                });
        }
        
        function placeWindowLeft() {
            const windowId = prompt('Enter the window ID (e.g. 0x12345678):');
            if (windowId) {
                fetch(`/visual/place_window/${{windowId}}/left`)
                    .then(r => r.text())
                    .then(data => {
                        alert(data);
                        location.reload();
                    })
                    .catch(() => {
                        alert('Error placing window');
                    });
            }
        }

        function placeWindowRight() {
            const windowId = prompt('Enter the window ID (e.g. 0x12345678):');
            if (windowId) {
                fetch(`/visual/place_window/${windowId}/right`)
                    .then(r => r.text())
                    .then(data => {
                        alert(data);
                        location.reload();
                    })
                    .catch(() => {
                        alert('Error placing window');
                    });
            }
        }

        const modal = document.getElementById('fullscreenModal');
        const fullscreenImage = document.getElementById('fullscreenImage');
        const modalInfo = document.querySelector('.modal-info');

        
        document.addEventListener('click', function(e) {
            if (e.target.matches('.video-container img')) {
                openFullscreen(e.target);
            }
        });

        function openFullscreen(imgElement) {
            const src = imgElement.src;
            const alt = imgElement.alt;
            
            
            fullscreenImage.src = src;
            fullscreenImage.alt = alt;
            
            
            modalInfo.textContent = alt + ' ‚Ä¢ Click on the image or press the ESC key to exit';
            
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; 
            
            
            if (src.includes('/visual/video_feed')) {
                fullscreenImage.classList.add('video');
            } else {
                fullscreenImage.classList.remove('video');
            }
        }


        function closeFullscreen() {
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        
        modal.addEventListener('click', function(e) {
            if (e.target === modal || e.target.classList.contains('close-modal')) {
                closeFullscreen();
            }
        });

        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                closeFullscreen();
            }
        });

        
        fullscreenImage.addEventListener('click', function(e) {
            e.stopPropagation();
        });


        window.onload = function() {
            setupVideo('videoTiled', 'statusTiled', '/visual/video_feed_tiled', true);
            updateStats();
            setInterval(updateStats, 5000);
            setInterval(updateWindowCount, 3000);
        };
    </script>
</body>
</html>